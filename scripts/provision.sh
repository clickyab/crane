#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR=$(readlink -f $(dirname ${BASH_SOURCE[0]}))

echo "export GOPATH=/home/develop/go" >> /home/develop/.zshrc
echo "export GOPATH=/home/develop/go" >> /etc/environment
echo "export PATH=$PATH:/usr/local/go/bin:/home/develop/go/bin" >> /home/develop/.zshrc
echo "alias cdp=\"cd /home/develop/go/src/clickyab.com/crane\"" >> /home/develop/.zshrc

cd /home/develop/go/src/clickyab.com/crane
make -f /home/develop/go/src/clickyab.com/crane/Makefile mysql-setup
make -f /home/develop/go/src/clickyab.com/crane/Makefile rabbitmq-setup
chown develop. /home/develop/go
chown develop. /home/develop/go/src
chown develop. /home/develop/go/src/clickyab.com

sudo -u develop /home/develop/go/src/clickyab.com/crane/scripts/provision_user.sh

sudo mkdir -p /tls/stream
sudo cat <<EOF > /tls/stream/tls.crt
-----BEGIN CERTIFICATE-----
MIIFPjCCBCagAwIBAgITAPo9c1DGJMvi66UGrVEEdXSEyTANBgkqhkiG9w0BAQsF
ADAiMSAwHgYDVQQDDBdGYWtlIExFIEludGVybWVkaWF0ZSBYMTAeFw0xODEyMTEw
NDM1MzdaFw0xOTAzMTEwNDM1MzdaMB4xHDAaBgNVBAMTE3N0cmVhbS5jbGlja3lh
Yi5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDkfIGv99XcA5ex
civwgica3I4E6rAccxw6rKYRYUgDKtZMb7IP5eJoBFKyHHIQACQAFygWgulI+qpO
rUeu1n6EpUi4pWl4aMZhWs6d1YrIniAxFaGjwJg6JHahV5Hsd6xxLJ6nxiiBdato
2tNIoVpEyVyDUEhOqoYJs8VumlAzL1mHpQmXN+dYoovVKv0d2c27FkRGNnVO6mEs
L+woGTtGrWHClU4j3hk4moS3M2ZGAP6TsXKbn3djlJOlNZnk8tqgsmO2no1pHWVZ
58nL8IB0b+Xo7nsmd/fY4ZVMszB+zcRuLj+wjpCnqVcPS5a/3UlwJJYhwyaEg5gr
GQwH93XHAgMBAAGjggJvMIICazAOBgNVHQ8BAf8EBAMCBaAwHQYDVR0lBBYwFAYI
KwYBBQUHAwEGCCsGAQUFBwMCMAwGA1UdEwEB/wQCMAAwHQYDVR0OBBYEFOr7nzZF
i++PVMrsJ/GIogdiwmsxMB8GA1UdIwQYMBaAFMDMA0a5WCDMXHJw8+EuyyCm9Wg6
MHcGCCsGAQUFBwEBBGswaTAyBggrBgEFBQcwAYYmaHR0cDovL29jc3Auc3RnLWlu
dC14MS5sZXRzZW5jcnlwdC5vcmcwMwYIKwYBBQUHMAKGJ2h0dHA6Ly9jZXJ0LnN0
Zy1pbnQteDEubGV0c2VuY3J5cHQub3JnLzAeBgNVHREEFzAVghNzdHJlYW0uY2xp
Y2t5YWIuY29tMEwGA1UdIARFMEMwCAYGZ4EMAQIBMDcGCysGAQQBgt8TAQEBMCgw
JgYIKwYBBQUHAgEWGmh0dHA6Ly9jcHMubGV0c2VuY3J5cHQub3JnMIIBAwYKKwYB
BAHWeQIEAgSB9ASB8QDvAHYAsMyD5aX5fWuvfAnMKEkEhyrH6IsTLGNQt8b9JuFs
bHcAAAFnm8N2UwAABAMARzBFAiB+ZnVhzcgodugD5DgkquVlAKmro7MsPKxVagDI
wQaJgwIhAPObaQqDymXMy8XrHWXBj16vxKyT4O+yoFlHJzm07PjSAHUA3Zk0/KXn
JIDJVmh9gTSZCEmySfe1adjHvKs/XMHzbmQAAAFnm8N4YgAABAMARjBEAiAzvR8z
UTD6Nm7qc1PSNFFNYercz8gqmKLaWQ7zatPYCwIgG3u9y091TLIW17BRTnVKVg+S
NTeyWOYF4/lpTWM7UXYwDQYJKoZIhvcNAQELBQADggEBAA5rh6H8NEms73sIjXlb
4/mHPlWuqJW1TeEAgVi0or/4wjnLSiErYoXHCRMcVQzJdU++A/++biYI7V3t6xY6
8rbmEDHbH79zmdTFR8bm/WHyguWopmXtVUjIxGQyuAypy2clmp0v8y3dsievxf/n
L34dc5lOtIUOpoM6SzPKzpGcpQRA6JaH0B6eUquSv0gZV4TOrCkDnUmGvmSGvZF1
QFX1eiaLRREXZWwGqiaPdhdaSHlax/1frm/VEkz1Izr95o8avPvivUfY/5QLN3V/
lZ349lLGpKu8uVn/d05dMXIxfGzTKhlH0rpKG/egzt+uWeQxh7Jkj0GWv0uUnqne
bps=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEqzCCApOgAwIBAgIRAIvhKg5ZRO08VGQx8JdhT+UwDQYJKoZIhvcNAQELBQAw
GjEYMBYGA1UEAwwPRmFrZSBMRSBSb290IFgxMB4XDTE2MDUyMzIyMDc1OVoXDTM2
MDUyMzIyMDc1OVowIjEgMB4GA1UEAwwXRmFrZSBMRSBJbnRlcm1lZGlhdGUgWDEw
ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDtWKySDn7rWZc5ggjz3ZB0
8jO4xti3uzINfD5sQ7Lj7hzetUT+wQob+iXSZkhnvx+IvdbXF5/yt8aWPpUKnPym
oLxsYiI5gQBLxNDzIec0OIaflWqAr29m7J8+NNtApEN8nZFnf3bhehZW7AxmS1m0
ZnSsdHw0Fw+bgixPg2MQ9k9oefFeqa+7Kqdlz5bbrUYV2volxhDFtnI4Mh8BiWCN
xDH1Hizq+GKCcHsinDZWurCqder/afJBnQs+SBSL6MVApHt+d35zjBD92fO2Je56
dhMfzCgOKXeJ340WhW3TjD1zqLZXeaCyUNRnfOmWZV8nEhtHOFbUCU7r/KkjMZO9
AgMBAAGjgeMwgeAwDgYDVR0PAQH/BAQDAgGGMBIGA1UdEwEB/wQIMAYBAf8CAQAw
HQYDVR0OBBYEFMDMA0a5WCDMXHJw8+EuyyCm9Wg6MHoGCCsGAQUFBwEBBG4wbDA0
BggrBgEFBQcwAYYoaHR0cDovL29jc3Auc3RnLXJvb3QteDEubGV0c2VuY3J5cHQu
b3JnLzA0BggrBgEFBQcwAoYoaHR0cDovL2NlcnQuc3RnLXJvb3QteDEubGV0c2Vu
Y3J5cHQub3JnLzAfBgNVHSMEGDAWgBTBJnSkikSg5vogKNhcI5pFiBh54DANBgkq
hkiG9w0BAQsFAAOCAgEABYSu4Il+fI0MYU42OTmEj+1HqQ5DvyAeyCA6sGuZdwjF
UGeVOv3NnLyfofuUOjEbY5irFCDtnv+0ckukUZN9lz4Q2YjWGUpW4TTu3ieTsaC9
AFvCSgNHJyWSVtWvB5XDxsqawl1KzHzzwr132bF2rtGtazSqVqK9E07sGHMCf+zp
DQVDVVGtqZPHwX3KqUtefE621b8RI6VCl4oD30Olf8pjuzG4JKBFRFclzLRjo/h7
IkkfjZ8wDa7faOjVXx6n+eUQ29cIMCzr8/rNWHS9pYGGQKJiY2xmVC9h12H99Xyf
zWE9vb5zKP3MVG6neX1hSdo7PEAb9fqRhHkqVsqUvJlIRmvXvVKTwNCP3eCjRCCI
PTAvjV+4ni786iXwwFYNz8l3PmPLCyQXWGohnJ8iBm+5nk7O2ynaPVW0U2W+pt2w
SVuvdDM5zGv2f9ltNWUiYZHJ1mmO97jSY/6YfdOUH66iRtQtDkHBRdkNBsMbD+Em
2TgBldtHNSJBfB3pm9FblgOcJ0FSWcUDWJ7vO0+NTXlgrRofRT6pVywzxVo6dND0
WzYlTWeUVsO40xJqhgUQRER9YLOLxJ0O6C8i0xFxAMKOtSdodMB3RIwt7RFQ0uyt
n5Z5MqkYhlMI3J1tPRTp1nEt9fyGspBOO05gi148Qasp+3N+svqKomoQglNoAxU=
-----END CERTIFICATE-----
EOF

sudo cat <<EOF > /tls/stream/tls.key
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA5HyBr/fV3AOXsXIr8IInGtyOBOqwHHMcOqymEWFIAyrWTG+y
D+XiaARSshxyEAAkABcoFoLpSPqqTq1HrtZ+hKVIuKVpeGjGYVrOndWKyJ4gMRWh
o8CYOiR2oVeR7HescSyep8YogXWraNrTSKFaRMlcg1BITqqGCbPFbppQMy9Zh6UJ
lzfnWKKL1Sr9HdnNuxZERjZ1TuphLC/sKBk7Rq1hwpVOI94ZOJqEtzNmRgD+k7Fy
m593Y5STpTWZ5PLaoLJjtp6NaR1lWefJy/CAdG/l6O57Jnf32OGVTLMwfs3Ebi4/
sI6Qp6lXD0uWv91JcCSWIcMmhIOYKxkMB/d1xwIDAQABAoIBAQCNI4fszhgR7zou
B4uy5oMHacRkryAYgtamO+3dgI0+P6De2IRSo7uGa1013rJqxdt3HtbJiRZX2VeI
gCtuidrfT0YroSoUkgwxKSnGf5laMatLBsSxZY/jIpEROwnN22LvChP7KUHuLmSy
wbGQBPPA1+3Iw7fWuClSJvVHTBVMd8Euv5RdtBaUFFSYg3HfmYX9DgMYGWSWA80N
7ZIRZTbGlVKJKbj35ASLDR42fCyCT6MMpxCi/re2YzqBMzU8PS0ymfPO3e1FUBZ3
eiXQ4FzTL2+L9qycf9AC08N/8C4k+PHVz2xCdA67VoT8DwsVA43/QhxEBXQS5C7W
uWBXqdn5AoGBAPynK7HvvKNYgQioP7eCS5MfRcT15Xc1UwBiHSXjXxRvpZcEYe2/
eUfbsqHELa3/DXzarUmXhX98XJ3dFK2AuNZkA9makJyvmRGhlXEYWMLu2hQ+SIL9
AO0QW4zO6zxF84qCL2DU/W8VqblV8D/qXQ5pH8H/fjqBdYGIUSg7Y2vlAoGBAOeD
YPumVyMKZq0W7NZ06mYMZOzGeHXd/q/eQsIgbxoF8eYVVR/+oKY91wNseMWvwIK2
tRgJYsFeEMRPJx/H6o6me1C+HlFUVhvij0kbdrhbtvm+ScRdKhfC/ebtZTdT3dG9
zLx7r5QLcUTV1Px4AhYkjlBfpfUlvRP0ia8Kbbg7AoGATvjd8pdyCkjOxGr6x5yF
jO4Ye9E0sYdMc3E3lTE19ghT5Rlslsjj2u80LdZJRPrVN3KO+dLP2qJ/vKRvIzB6
FiFbBriGfUNyAA3WzWwDyqKoLe2t8qusj20ugJvo8YUX8/JvZsAMm51U2Oag2wmh
nrCDSbtXtGfk1+FJJN8zW3UCgYBpUAYp8zzoH68dRbRuybhmu3SdkJrzYwycC8rq
a76eY93qAAI9D6McfDz2vb0ikBROYbZ3PK3DsHqIEkmF13cHdQvbauB3tpmFDcaI
Rwn2SyIs8Ta1MHwZWwYMqijExk29P02G3+y6t4nK+kpsnlq0n+RtA1WG8qfUEAUh
rujCSQKBgQCagh9vvYY2gXf1bOKKs0oZ53gIeYUOS7LL1dPLFTszU+AwTGuCaIju
wOeHVekMGmSN5+I8ZoAuLM/EOOn6b8upOLO0xelvp1sZtNNbVr0k2DTNuPdvzj2g
CoThJv8sGtkF6q4fSGB9W7rwcbFnAYZJgQjrLsSJv4gRE+ple/oo5w==
-----END RSA PRIVATE KEY-----
EOF

chown develop. /tls/stream/tls.key
chown develop. /tls/stream/tls.crt